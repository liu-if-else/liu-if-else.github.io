<!DOCTYPE html>
<html lang="en" class="no-js">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    

    
    

    
    

    
    

    <title>Stencil Buffer's Uses in Unity3D | liu_if_else's blog</title>
    <meta name="description" content="Demonstrate the uses of Unity Stencil Buffer with outlining, polygon filling, mirror restricting and shadow volume.">
    
        <meta name="keywords" content="Shader, Unity3D">
    

    <!-- Social: Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Stencil Buffer's Uses in Unity3D | liu_if_else's blog">
    <meta name="twitter:description" content="Demonstrate the uses of Unity Stencil Buffer with outlining, polygon filling, mirror restricting and shadow volume.">
    <meta property="twitter:image:src" content="https://res.cloudinary.com/dokdkay80/image/upload/c_scale,w_760/v1604503676/StencilBuffer/p1_fddhcm.png">
    
        <meta name="twitter:site" content="@twitter_username">
    

    <!-- Social: Facebook / Open Graph -->
    <meta property="og:url" content="http://localhost:4000/stencil-buffer's-uses-in-unity3d/">
    <meta property="og:title" content="Stencil Buffer's Uses in Unity3D | liu_if_else's blog">
    <meta property="og:image" content="https://res.cloudinary.com/dokdkay80/image/upload/c_scale,w_760/v1604503676/StencilBuffer/p1_fddhcm.png">
    <meta property="og:description" content="Demonstrate the uses of Unity Stencil Buffer with outlining, polygon filling, mirror restricting and shadow volume.">
    <meta property="og:site_name" content="liu_if_else's blog">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/assets/img/icons/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/img/icons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/img/icons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/icons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/img/icons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/img/icons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/img/icons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/img/icons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/img/icons/apple-touch-icon-152x152.png" />

    <!-- Windows 8 Tile Icons -->
    <meta name="application-name" content="liu_if_else's blog">
    <meta name="msapplication-TileColor" content="#141414">
    <meta name="msapplication-square70x70logo" content="smalltile.png" />
    <meta name="msapplication-square150x150logo" content="mediumtile.png" />
    <meta name="msapplication-wide310x150logo" content="widetile.png" />
    <meta name="msapplication-square310x310logo" content="largetile.png" />
    
    <!-- Android Lolipop Theme Color -->
    <meta name="theme-color" content="#141414">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web:300,400,700" rel="stylesheet">

    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="canonical" href="http://localhost:4000/stencil-buffer's-uses-in-unity3d/">
    <link rel="alternate" type="application/rss+xml" title="liu_if_else's blog" href="http://localhost:4000/feed.xml" />

    <!-- Include extra styles -->
    

    <!-- JavaScript enabled/disabled -->
    <script>
        document.querySelector('html').classList.remove('no-js');
    </script>
</head>

    <body class="has-push-menu">
        





        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" display="none" version="1.1"><defs><symbol id="icon-menu" viewBox="0 0 1024 1024"><path class="path1" d="M128 213.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 725.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 469.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5z"/></symbol><symbol id="icon-search" viewBox="0 0 951 1024"><path class="path1" d="M658.286 475.429q0-105.714-75.143-180.857t-180.857-75.143-180.857 75.143-75.143 180.857 75.143 180.857 180.857 75.143 180.857-75.143 75.143-180.857zM950.857 950.857q0 29.714-21.714 51.429t-51.429 21.714q-30.857 0-51.429-21.714l-196-195.429q-102.286 70.857-228 70.857-81.714 0-156.286-31.714t-128.571-85.714-85.714-128.571-31.714-156.286 31.714-156.286 85.714-128.571 128.571-85.714 156.286-31.714 156.286 31.714 128.571 85.714 85.714 128.571 31.714 156.286q0 125.714-70.857 228l196 196q21.143 21.143 21.143 51.429z"/></symbol><symbol id="icon-close" viewBox="0 0 1000 1000"><path d="M969.8,870.3c27,27.7,27,71.8,0,99.1C955.7,983,937.9,990,920,990c-17.9,0-35.7-7-49.7-20.7L500,599L129.6,969.4C115.6,983,97.8,990,79.9,990s-35.7-7-49.7-20.7c-27-27.3-27-71.4,0-99.1L400.9,500L30.3,129.3c-27-27.3-27-71.4,0-99.1c27.3-27,71.8-27,99.4,0L500,400.9L870.4,30.2c27.7-27,71.8-27,99.4,0c27,27.7,27,71.8,0,99.1L599.1,500L969.8,870.3z"/></symbol><symbol id="icon-twitter" viewBox="0 0 951 1024"><path class="path1" d="M925.714 233.143q-38.286 56-92.571 95.429 0.571 8 0.571 24 0 74.286-21.714 148.286t-66 142-105.429 120.286-147.429 83.429-184.571 31.143q-154.857 0-283.429-82.857 20 2.286 44.571 2.286 128.571 0 229.143-78.857-60-1.143-107.429-36.857t-65.143-91.143q18.857 2.857 34.857 2.857 24.571 0 48.571-6.286-64-13.143-106-63.714t-42-117.429v-2.286q38.857 21.714 83.429 23.429-37.714-25.143-60-65.714t-22.286-88q0-50.286 25.143-93.143 69.143 85.143 168.286 136.286t212.286 56.857q-4.571-21.714-4.571-42.286 0-76.571 54-130.571t130.571-54q80 0 134.857 58.286 62.286-12 117.143-44.571-21.143 65.714-81.143 101.714 53.143-5.714 106.286-28.571z"/></symbol><symbol id="icon-facebook" viewBox="0 0 585 1024"><path class="path1" d="M548 6.857v150.857h-89.714q-49.143 0-66.286 20.571t-17.143 61.714v108h167.429l-22.286 169.143h-145.143v433.714h-174.857v-433.714h-145.714v-169.143h145.714v-124.571q0-106.286 59.429-164.857t158.286-58.571q84 0 130.286 6.857z"/></symbol><symbol id="icon-clock" viewBox="0 0 1000 1000"><path d="M500,10C229.8,10,10,229.8,10,500c0,270.2,219.8,490,490,490c270.2,0,490-219.8,490-490C990,229.8,770.2,10,500,10z M500,910.2c-226.2,0-410.2-184-410.2-410.2c0-226.2,184-410.2,410.2-410.2c226.2,0,410.2,184,410.2,410.2C910.2,726.1,726.2,910.2,500,910.2z M753.1,374c8.2,11.9,5.2,28.1-6.6,36.3L509.9,573.7c-4.4,3.1-9.6,4.6-14.8,4.6c-4.1,0-8.3-1-12.1-3c-8.6-4.5-14-13.4-14-23.1V202.5c0-14.4,11.7-26.1,26.1-26.1c14.4,0,26.1,11.7,26.1,26.1v300l195.6-135.1C728.7,359.2,744.9,362.1,753.1,374z"/></symbol><symbol id="icon-calendar" viewBox="0 0 1000 1000"><path d="M920,500v420H80V500H920 M990,430H10v490c0,38.7,31.3,70,70,70h840c38.7,0,70-31.3,70-70V430L990,430z"/><path d="M850,80v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80H360v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80C72.8,80,10,142.7,10,220v140h980V220C990,142.7,927.2,80,850,80z"/><path d="M255,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C290,25.8,274.3,10,255,10z"/><path d="M745,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C780,25.8,764.3,10,745,10z"/></symbol><symbol id="icon-github" viewBox="0 0 12 14"><path d="M6 1q1.633 0 3.012 0.805t2.184 2.184 0.805 3.012q0 1.961-1.145 3.527t-2.957 2.168q-0.211 0.039-0.312-0.055t-0.102-0.234q0-0.023 0.004-0.598t0.004-1.051q0-0.758-0.406-1.109 0.445-0.047 0.801-0.141t0.734-0.305 0.633-0.52 0.414-0.82 0.16-1.176q0-0.93-0.617-1.609 0.289-0.711-0.062-1.594-0.219-0.070-0.633 0.086t-0.719 0.344l-0.297 0.187q-0.727-0.203-1.5-0.203t-1.5 0.203q-0.125-0.086-0.332-0.211t-0.652-0.301-0.664-0.105q-0.352 0.883-0.062 1.594-0.617 0.68-0.617 1.609 0 0.664 0.16 1.172t0.41 0.82 0.629 0.523 0.734 0.305 0.801 0.141q-0.305 0.281-0.383 0.805-0.164 0.078-0.352 0.117t-0.445 0.039-0.512-0.168-0.434-0.488q-0.148-0.25-0.379-0.406t-0.387-0.187l-0.156-0.023q-0.164 0-0.227 0.035t-0.039 0.090 0.070 0.109 0.102 0.094l0.055 0.039q0.172 0.078 0.34 0.297t0.246 0.398l0.078 0.18q0.102 0.297 0.344 0.48t0.523 0.234 0.543 0.055 0.434-0.027l0.18-0.031q0 0.297 0.004 0.691t0.004 0.426q0 0.141-0.102 0.234t-0.312 0.055q-1.812-0.602-2.957-2.168t-1.145-3.527q0-1.633 0.805-3.012t2.184-2.184 3.012-0.805zM2.273 9.617q0.023-0.055-0.055-0.094-0.078-0.023-0.102 0.016-0.023 0.055 0.055 0.094 0.070 0.047 0.102-0.016zM2.516 9.883q0.055-0.039-0.016-0.125-0.078-0.070-0.125-0.023-0.055 0.039 0.016 0.125 0.078 0.078 0.125 0.023zM2.75 10.234q0.070-0.055 0-0.148-0.062-0.102-0.133-0.047-0.070 0.039 0 0.141t0.133 0.055zM3.078 10.562q0.062-0.062-0.031-0.148-0.094-0.094-0.156-0.023-0.070 0.062 0.031 0.148 0.094 0.094 0.156 0.023zM3.523 10.758q0.023-0.086-0.102-0.125-0.117-0.031-0.148 0.055t0.102 0.117q0.117 0.047 0.148-0.047zM4.016 10.797q0-0.102-0.133-0.086-0.125 0-0.125 0.086 0 0.102 0.133 0.086 0.125 0 0.125-0.086zM4.469 10.719q-0.016-0.086-0.141-0.070-0.125 0.023-0.109 0.117t0.141 0.062 0.109-0.109z"></path></symbol><symbol id="icon-medium" viewBox="0 0 1000 1000"><path d="M336.5,240.2v641.5c0,9.1-2.3,16.9-6.8,23.2s-11.2,9.6-20,9.6c-6.2,0-12.2-1.5-18-4.4L37.3,782.7c-7.7-3.6-14.1-9.8-19.4-18.3S10,747.4,10,739V115.5c0-7.3,1.8-13.5,5.5-18.6c3.6-5.1,8.9-7.7,15.9-7.7c5.1,0,13.1,2.7,24.1,8.2l279.5,140C335.9,238.6,336.5,239.5,336.5,240.2L336.5,240.2z M371.5,295.5l292,473.6l-292-145.5V295.5z M990,305.3v576.4c0,9.1-2.6,16.5-7.7,22.1c-5.1,5.7-12,8.5-20.8,8.5s-17.3-2.4-25.7-7.1L694.7,784.9L990,305.3z M988.4,239.7c0,1.1-46.8,77.6-140.3,229.4C754.6,621,699.8,709.8,683.8,735.7L470.5,389l177.2-288.2c6.2-10.2,15.7-15.3,28.4-15.3c5.1,0,9.8,1.1,14.2,3.3l295.9,147.7C987.6,237.1,988.4,238.2,988.4,239.7L988.4,239.7z"/></symbol><symbol id="icon-instagram" viewBox="0 0 489.84 489.84"><path d="M249.62,50.46c65.4,0,73.14.25,99,1.43C372.47,53,385.44,57,394.07,60.32a75.88,75.88,0,0,1,28.16,18.32,75.88,75.88,0,0,1,18.32,28.16c3.35,8.63,7.34,21.6,8.43,45.48,1.18,25.83,1.43,33.57,1.43,99s-0.25,73.14-1.43,99c-1.09,23.88-5.08,36.85-8.43,45.48a81.11,81.11,0,0,1-46.48,46.48c-8.63,3.35-21.6,7.34-45.48,8.43-25.82,1.18-33.57,1.43-99,1.43s-73.15-.25-99-1.43c-23.88-1.09-36.85-5.08-45.48-8.43A75.88,75.88,0,0,1,77,423.86,75.88,75.88,0,0,1,58.69,395.7c-3.35-8.63-7.34-21.6-8.43-45.48-1.18-25.83-1.43-33.57-1.43-99s0.25-73.14,1.43-99c1.09-23.88,5.08-36.85,8.43-45.48A75.88,75.88,0,0,1,77,78.64a75.88,75.88,0,0,1,28.16-18.32c8.63-3.35,21.6-7.34,45.48-8.43,25.83-1.18,33.57-1.43,99-1.43m0-44.13c-66.52,0-74.86.28-101,1.47s-43.87,5.33-59.45,11.38A120.06,120.06,0,0,0,45.81,47.44,120.06,120.06,0,0,0,17.56,90.82C11.5,106.4,7.36,124.2,6.17,150.27s-1.47,34.46-1.47,101,0.28,74.86,1.47,101,5.33,43.87,11.38,59.45a120.06,120.06,0,0,0,28.25,43.38,120.06,120.06,0,0,0,43.38,28.25c15.58,6.05,33.38,10.19,59.45,11.38s34.46,1.47,101,1.47,74.86-.28,101-1.47,43.87-5.33,59.45-11.38a125.24,125.24,0,0,0,71.63-71.63c6.05-15.58,10.19-33.38,11.38-59.45s1.47-34.46,1.47-101-0.28-74.86-1.47-101-5.33-43.87-11.38-59.45a120.06,120.06,0,0,0-28.25-43.38,120.06,120.06,0,0,0-43.38-28.25C394.47,13.13,376.67,9,350.6,7.8s-34.46-1.47-101-1.47h0Z" transform="translate(-4.7 -6.33)" /><path d="M249.62,125.48A125.77,125.77,0,1,0,375.39,251.25,125.77,125.77,0,0,0,249.62,125.48Zm0,207.41a81.64,81.64,0,1,1,81.64-81.64A81.64,81.64,0,0,1,249.62,332.89Z" transform="translate(-4.7 -6.33)"/><circle cx="375.66" cy="114.18" r="29.39" /></symbol><symbol id="icon-linkedin" viewBox="0 0 12 14"><path d="M2.727 4.883v7.742h-2.578v-7.742h2.578zM2.891 2.492q0.008 0.57-0.395 0.953t-1.059 0.383h-0.016q-0.641 0-1.031-0.383t-0.391-0.953q0-0.578 0.402-0.957t1.051-0.379 1.039 0.379 0.398 0.957zM12 8.187v4.437h-2.57v-4.141q0-0.82-0.316-1.285t-0.988-0.465q-0.492 0-0.824 0.27t-0.496 0.668q-0.086 0.234-0.086 0.633v4.32h-2.57q0.016-3.117 0.016-5.055t-0.008-2.313l-0.008-0.375h2.57v1.125h-0.016q0.156-0.25 0.32-0.438t0.441-0.406 0.68-0.34 0.895-0.121q1.336 0 2.148 0.887t0.813 2.598z"></path></symbol><symbol id="icon-heart" viewBox="0 0 34 30"><path d="M17,29.7 L16.4,29.2 C3.5,18.7 0,15 0,9 C0,4 4,0 9,0 C13.1,0 15.4,2.3 17,4.1 C18.6,2.3 20.9,0 25,0 C30,0 34,4 34,9 C34,15 30.5,18.7 17.6,29.2 L17,29.7 Z M9,2 C5.1,2 2,5.1 2,9 C2,14.1 5.2,17.5 17,27.1 C28.8,17.5 32,14.1 32,9 C32,5.1 28.9,2 25,2 C21.5,2 19.6,4.1 18.1,5.8 L17,7.1 L15.9,5.8 C14.4,4.1 12.5,2 9,2 Z" id="Shape"></path></symbol><symbol id="icon-arrow-right" viewBox="0 0 25.452 25.452"><path d="M4.471,24.929v-2.004l12.409-9.788c0.122-0.101,0.195-0.251,0.195-0.411c0-0.156-0.073-0.31-0.195-0.409L4.471,2.526V0.522c0-0.2,0.115-0.384,0.293-0.469c0.18-0.087,0.396-0.066,0.552,0.061l15.47,12.202c0.123,0.1,0.195,0.253,0.195,0.409c0,0.16-0.072,0.311-0.195,0.411L5.316,25.34c-0.155,0.125-0.372,0.147-0.552,0.061C4.586,25.315,4.471,25.13,4.471,24.929z"/></symbol><symbol id="icon-star" viewBox="0 0 48 48"><path fill="currentColor" d="M44,24c0,11.045-8.955,20-20,20S4,35.045,4,24S12.955,4,24,4S44,12.955,44,24z"/><path fill="#ffffff" d="M24,11l3.898,7.898l8.703,1.301l-6.301,6.102l1.5,8.699L24,30.898L16.199,35l1.5-8.699l-6.301-6.102  l8.703-1.301L24,11z"/></symbol><symbol id="icon-read" viewBox="0 0 32 32"><path fill="currentColor" d="M29,4H3C1.343,4,0,5.343,0,7v18c0,1.657,1.343,3,3,3h10c0,0.552,0.448,1,1,1h4c0.552,0,1-0.448,1-1h10  c1.657,0,3-1.343,3-3V7C32,5.343,30.657,4,29,4z M29,5v20H18.708c-0.618,0-1.236,0.146-1.789,0.422l-0.419,0.21V5H29z M15.5,5  v20.632l-0.419-0.21C14.528,25.146,13.91,25,13.292,25H3V5H15.5z M31,25c0,1.103-0.897,2-2,2H18v1h-4v-1H3c-1.103,0-2-0.897-2-2V7  c0-0.737,0.405-1.375,1-1.722V25c0,0.552,0.448,1,1,1h10.292c0.466,0,0.925,0.108,1.342,0.317l0.919,0.46  c0.141,0.07,0.294,0.106,0.447,0.106c0.153,0,0.306-0.035,0.447-0.106l0.919-0.46C17.783,26.108,18.242,26,18.708,26H29  c0.552,0,1-0.448,1-1V5.278C30.595,5.625,31,6.263,31,7V25z M6,12.5C6,12.224,6.224,12,6.5,12h5c0.276,0,0.5,0.224,0.5,0.5  S11.776,13,11.5,13h-5C6.224,13,6,12.776,6,12.5z M6,14.5C6,14.224,6.224,14,6.5,14h5c0.276,0,0.5,0.224,0.5,0.5S11.776,15,11.5,15  h-5C6.224,15,6,14.776,6,14.5z M6,16.5C6,16.224,6.224,16,6.5,16h5c0.276,0,0.5,0.224,0.5,0.5S11.776,17,11.5,17h-5  C6.224,17,6,16.776,6,16.5z M20,12.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,13,25.5,13h-5  C20.224,13,20,12.776,20,12.5z M20,14.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,15,25.5,15h-5  C20.224,15,20,14.776,20,14.5z M20,16.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,17,25.5,17h-5  C20.224,17,20,16.776,20,16.5z"></path></symbol></defs></svg>

        <header class="bar-header">
    <a id="menu" role="button">
        <svg id="open" class="icon-menu"><use xlink:href="#icon-menu"></use></svg>
    </a>
    <h1 class="logo">
        <a href="/">
            
                liu_if_else's blog <span class="version">v1.0.0</span>
            
        </a>
    </h1>
    <a id="search" class="dosearch" role="button">
        <svg class="icon-search"><use xlink:href="#icon-search"></use></svg>
    </a>
    
</header>

<div id="mask" class="overlay"></div>

<aside class="sidebar" id="sidebar">
    <nav id="navigation">
      <h2>Menu</h2>
      <ul>
  
    
      <li>
        <a href="http://localhost:4000/">Home</a>
      </li>
    
  
    
      <li>
        <a href="http://localhost:4000/about">About</a>
      </li>
    
  
    
      <li>
        <a href="http://localhost:4000/contact">Contact</a>
      </li>
    
  
    
      <li>
        <a href="http://localhost:4000/feed.xml">Feed</a>
      </li>
    
  
</ul>

    </nav>
</aside>

<div class="search-wrapper">
    <div class="search-form">
        <input type="text" class="search-field" placeholder="Search">
        <svg class="icon-remove-sign"><use xlink:href="#icon-close"></use></svg>
        <ul class="search-results search-list"></ul>
    </div>
</div>



        <section class="post one-column">
            <article role="article" class="post-content">
                <p class="post-info">
                    
                        <svg class="icon-calendar" id="date"><use xlink:href="#icon-calendar"></use></svg>
                        <time class="date" datetime="2020-11-17T19:01:47+08:00">
                            


November 17, 2020

                        </time>
                    
                    <svg id="clock" class="icon-clock"><use xlink:href="#icon-clock"></use></svg>
                    <span>24 min to read</span>
                </p>
                <h1 class="post-title">Stencil Buffer's Uses in Unity3D</h1>
                <p class="post-subtitle">Outlining, polygon filling, mirror restricting and shadow volume.</p>

                
                    <img src="https://res.cloudinary.com/dokdkay80/image/upload/c_scale,w_760/v1604503676/StencilBuffer/p1_fddhcm.png" alt="Featured image" class="post-cover">
                

                <!-- Pagination links -->



                <!-- Add your table of contents here -->


                <h1 id="menu">Menu</h1>
<ul>
  <li><a href="#the-stencil-buffer">The stencil buffer</a>
    <ul>
      <li><a href="#the-stencil">The stencil</a></li>
      <li><a href="#stencil-and-depth-buffer">Stencil and depth buffer</a></li>
      <li><a href="#reading-and-writing">Reading and writing</a></li>
    </ul>
  </li>
  <li><a href="#outlining">Outlining</a>
    <ul>
      <li><a href="#the-shader-snippet">The shader snippet</a></li>
      <li><a href="#remarks">Remarks</a></li>
      <li><a href="#the-resulting-screenshots">The resulting screenshots</a></li>
    </ul>
  </li>
  <li><a href="#polygon-filling">Polygon Filling</a>
    <ul>
      <li><a href="#the-shader-snippet-1">The shader snippet</a></li>
      <li><a href="#remarks-1">Remarks</a></li>
      <li><a href="#the-resulting-screenshots-1">The resulting screenshots</a></li>
    </ul>
  </li>
  <li><a href="#mirror-restricting">Mirror Restricting</a>
    <ul>
      <li><a href="#the-shader-snippets">The shader snippets</a></li>
      <li><a href="#remarks-2">Remarks</a></li>
      <li><a href="#the-resulting-screenshots-2">The resulting screenshots</a></li>
    </ul>
  </li>
  <li><a href="#shadow-volume">Shadow Volume</a>
    <ul>
      <li><a href="#the-shader-snippet-2">The shader snippet</a></li>
      <li><a href="#remarks-3">Remarks</a></li>
      <li><a href="#the-resulting-screenshots-3">The resulting screenshots</a></li>
    </ul>
  </li>
</ul>

<h1 id="the-stencil-buffer">The stencil buffer</h1>

<h2 id="the-stencil">The stencil</h2>

<p>A stencil is a flat material where parts, usually shapes or patterns, have been cutted out. It’s a common and traditional tool used by many industries such as printing, clothing, painting and etc. Through those holes, you draw or paint the desired images on the surface below the stencil.</p>

<p>If you imagine the computer screen as a x*y matrix of 0, the stencil buffer decides the shape of the holes by setting parts of those zeros to 1,2,3,…, and 255. In each pass of the shader, all the operations are filtered by the pre-setting stencil value. The pixels will be discarded if they don’t have that stencil number. In this way, the stencil buffer becomes a mask and the render texture the paper under it.</p>

<h2 id="stencil-and-depth-buffer">Stencil and depth buffer</h2>

<p>According to the Wikipedia, the very modern GPU architecture binds the stencil and depth buffer together. For instance, in a continuous 32 bits area of the Graphics RAM, there could be 24 bits for depth buffer and 8 bits for stencil buffer of a fragment. When you create a render-texture in Unity, setting RenderTexture.depth to 32 will enable a 8 bits stencil buffer while 16(and 24?) will disable it. Maybe because of they are so close together, you can actually get the Z-test result in the stencil testing.</p>

<h2 id="reading-and-writing">Reading and writing</h2>

<p>In the OpenGL pipeline, between the fragment shader and the Blending, there are three testing stages that are scissor testing, stencil testing and Z-testing. All these testing operations have the OpenGL state machine style syntax, which is all about pre-setting and keywords.</p>

<p>For stencil test, you need to firstly declar a Stencil structure in SubShader or Pass scope, and then use “Ref” to set a base stencil value to compare, “Comp” to set a comparing condition, “Pass” to determine the furthur operation if the comparetion successes, “Fail” in the opposite scenario, and “ZFail” if the comparetion successes but depth test fails. All the comparison functions and stencil operation keywords can be found at <a href="https://docs.unity3d.com/Manual/SL-Stencil.html">Unity documentation</a>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Stencil</span> <span class="p">{</span>
    <span class="c1">//the base value to compare with</span>
    <span class="n">Ref</span> <span class="mi">0</span>           <span class="c1">//value's range: 0-255</span>
    <span class="c1">//compare condition</span>
    <span class="n">Comp</span> <span class="n">Equal</span>     <span class="c1">//default keyword: always(always pass)</span>
    <span class="c1">//the furthur operation if the comparetion successes</span>
    <span class="n">Pass</span> <span class="n">keep</span>       <span class="c1">//default keyword: keep(keep the fragment's current stencil value)</span>
    <span class="c1">//the furthur operation if the comparetion fails</span>
    <span class="n">Fail</span> <span class="n">keep</span>       <span class="c1">//default keyword: keep</span>
    <span class="c1">//if the stencil comparetion successes but Z-test fails</span>
    <span class="n">ZFail</span> <span class="n">IncrWrap</span>  <span class="c1">//default keyword: keep</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="outlining">Outlining</h1>

<h2 id="the-shader-snippet">The shader snippet</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Shader</span> <span class="s">"Unlit/StentilOutline"</span>
<span class="p">{</span>
	<span class="n">Properties</span>
	<span class="p">{</span>
		<span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Texture"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
	<span class="p">}</span>
	<span class="n">SubShader</span>
	<span class="p">{</span>
		<span class="n">Tags</span> <span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Opaque"</span> <span class="p">}</span>
		<span class="n">LOD</span> <span class="mi">100</span>
		<span class="n">Stencil</span> <span class="p">{</span>
		     <span class="n">Ref</span> <span class="mi">0</span>          <span class="c1">//0-255</span>
		     <span class="n">Comp</span> <span class="n">Equal</span>     <span class="c1">//default:always</span>
		     <span class="n">Pass</span> <span class="n">IncrSat</span>   <span class="c1">//default:keep</span>
		     <span class="n">Fail</span> <span class="n">keep</span>      <span class="c1">//default:keep</span>
		     <span class="n">ZFail</span> <span class="n">keep</span>     <span class="c1">//default:keep</span>
		<span class="p">}</span>

		<span class="n">Pass</span>
		<span class="p">{</span>
			<span class="n">CGPROGRAM</span>
			<span class="cp">#pragma vertex vert
</span>			<span class="cp">#pragma fragment frag
</span>			<span class="c1">// make fog work</span>
			<span class="cp">#pragma multi_compile_fog
</span>			
			<span class="cp">#include "UnityCG.cginc"
</span>
			<span class="k">struct</span> <span class="n">appdata</span>
			<span class="p">{</span>
				<span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
				<span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
			<span class="p">};</span>

			<span class="k">struct</span> <span class="n">v2f</span>
			<span class="p">{</span>
				<span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
				<span class="n">UNITY_FOG_COORDS</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
			<span class="p">};</span>

			<span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
			<span class="n">float4</span> <span class="n">_MainTex_ST</span><span class="p">;</span>
			
			<span class="n">v2f</span> <span class="n">vert</span> <span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
				<span class="n">o</span><span class="p">.</span><span class="n">vertex</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
				<span class="n">o</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_MainTex</span><span class="p">);</span>
				<span class="n">UNITY_TRANSFER_FOG</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">o</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">o</span><span class="p">;</span>
			<span class="p">}</span>
			
			<span class="n">fixed4</span> <span class="n">frag</span> <span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
			<span class="p">{</span>
				<span class="c1">// sample the texture</span>
				<span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
				<span class="c1">// apply fog</span>
				<span class="n">UNITY_APPLY_FOG</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">fogCoord</span><span class="p">,</span> <span class="n">col</span><span class="p">);</span>
				<span class="c1">//return fixed4(1,1,0,1);</span>
				<span class="k">return</span> <span class="n">col</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ENDCG</span>
		<span class="p">}</span>

		<span class="n">Pass</span>
		<span class="p">{</span>
		    <span class="n">CGPROGRAM</span>
		    <span class="cp">#pragma vertex vert
</span>		    <span class="cp">#pragma fragment frag
</span>		    <span class="c1">// make fog work</span>
		    <span class="cp">#pragma multi_compile_fog
</span>		    
		    <span class="cp">#include "UnityCG.cginc"
</span>
		    <span class="k">struct</span> <span class="n">appdata</span>
		    <span class="p">{</span>
		        <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
		        <span class="n">float4</span> <span class="n">normal</span><span class="o">:</span> <span class="n">NORMAL</span><span class="p">;</span>
		        <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
		    <span class="p">};</span>

		    <span class="k">struct</span> <span class="n">v2f</span>
		    <span class="p">{</span>
		        <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
		        <span class="n">UNITY_FOG_COORDS</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
		        <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
		    <span class="p">};</span>

		    <span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
		    <span class="n">float4</span> <span class="n">_MainTex_ST</span><span class="p">;</span>
		    
		    <span class="n">v2f</span> <span class="n">vert</span> <span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">)</span>
		    <span class="p">{</span>
		        <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
		        <span class="n">o</span><span class="p">.</span><span class="n">vertex</span><span class="o">=</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="o">+</span><span class="n">normalize</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span><span class="p">.</span><span class="mo">01</span><span class="n">f</span><span class="p">;</span>
		        <span class="n">o</span><span class="p">.</span><span class="n">vertex</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
		        <span class="n">o</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_MainTex</span><span class="p">);</span>
		        <span class="n">UNITY_TRANSFER_FOG</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">o</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
		        <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
		    <span class="p">}</span>
		    
		    <span class="n">fixed4</span> <span class="n">frag</span> <span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
		    <span class="p">{</span>
		        <span class="c1">// sample the texture</span>
		        <span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
		        <span class="c1">// apply fog</span>
		        <span class="n">UNITY_APPLY_FOG</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">fogCoord</span><span class="p">,</span> <span class="n">col</span><span class="p">);</span>
		        <span class="k">return</span> <span class="n">fixed4</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
		    <span class="p">}</span>
		    <span class="n">ENDCG</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="remarks">Remarks</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		<span class="n">Stencil</span> <span class="p">{</span>
		     <span class="n">Ref</span> <span class="mi">0</span>          <span class="c1">//0-255</span>
		     <span class="n">Comp</span> <span class="n">Equal</span>     <span class="c1">//default:always</span>
		     <span class="n">Pass</span> <span class="n">IncrSat</span>   <span class="c1">//default:keep</span>
		     <span class="n">Fail</span> <span class="n">keep</span>      <span class="c1">//default:keep</span>
		     <span class="n">ZFail</span> <span class="n">keep</span>     <span class="c1">//default:keep</span>
		<span class="p">}</span>
</code></pre></div></div>
<p>The struct has writen in the SubShader scope so it works for all passes. In the first pass, under the ideal condition, all rasterized fragments will pass the “Ref 0” and “Comp Equal” test since zero is the initial stencil value. Then “Pass IncrSat” will add one to the stencil value of passed fragments. “Sat” makes the addition in the saturation style which means that if the value was 255 then it stays 255.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
		        <span class="n">o</span><span class="p">.</span><span class="n">vertex</span><span class="o">=</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="o">+</span><span class="n">normalize</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span><span class="p">.</span><span class="mo">01</span><span class="n">f</span><span class="p">;</span>
<span class="p">...</span>		       
</code></pre></div></div>

<p>In the second pass, verteces were magnified alone their normal direction at first. Most of the later rasterized fragments would be discarded since their stencil value is already one and could not pass the “Ref 0” and “Comp Equal” test. On the other hand, the stencil value of the fragments in the inflated area is still the initial value of zero thus they would succeed the test.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
                <span class="k">return</span> <span class="nf">fixed4</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="p">...</span>
</code></pre></div></div>

<p>Color these fragments and you get the rim.</p>

<h2 id="the-resulting-screenshots">The resulting screenshots</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="https://res.cloudinary.com/dokdkay80/image/upload/v1604503677/StencilBuffer/p6_e26gjj.png" alt="placeholder" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><span style="color: gray; font-size: 80%">Picture 1: Using the StencilPerPassOutline.shader in the demo project</span></td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="https://res.cloudinary.com/dokdkay80/image/upload/v1604503680/StencilBuffer/p3_ywdz2z.png" alt="placeholder" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><span style="color: gray; font-size: 80%">Picture 2: Using the StencilOutline.shader in the demo project</span></td>
    </tr>
  </tbody>
</table>

<h1 id="polygon-filling">Polygon Filling</h1>

<h2 id="the-shader-snippet-1">The shader snippet</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Shader</span> <span class="s">"Unlit/PolygonsBeta"</span>
<span class="p">{</span>
    <span class="n">Properties</span>
    <span class="p">{</span>
        <span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Texture"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">}</span>
    <span class="n">SubShader</span>
    <span class="p">{</span>
        <span class="n">Tags</span> <span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Opaque"</span> <span class="p">}</span>
        <span class="n">LOD</span> <span class="mi">100</span>

        <span class="n">CGINCLUDE</span>
        <span class="cp">#include "UnityCG.cginc"
</span>        <span class="k">struct</span> <span class="n">appdata</span>
        <span class="p">{</span>
            <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
            <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="k">struct</span> <span class="n">v2f</span>
        <span class="p">{</span>
            <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
            <span class="n">UNITY_FOG_COORDS</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
        <span class="n">float4</span> <span class="n">_MainTex_ST</span><span class="p">;</span>
        
        <span class="n">v2f</span> <span class="n">vert</span> <span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
            <span class="n">o</span><span class="p">.</span><span class="n">vertex</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
            <span class="n">o</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_MainTex</span><span class="p">);</span>
            <span class="n">UNITY_TRANSFER_FOG</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">o</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">ENDCG</span>

        <span class="n">Pass</span>
        <span class="p">{</span>
            <span class="n">Stencil</span> <span class="p">{</span>
                <span class="n">Ref</span> <span class="mi">0</span>           <span class="c1">//0-255</span>
                <span class="n">Comp</span> <span class="n">always</span>     <span class="c1">//default:always</span>
                <span class="n">Pass</span> <span class="n">IncrWrap</span>   <span class="c1">//default:keep</span>
                <span class="n">Fail</span> <span class="n">keep</span>       <span class="c1">//default:keep</span>
                <span class="n">ZFail</span> <span class="n">IncrWrap</span>  <span class="c1">//default:keep</span>
            <span class="p">}</span>

            <span class="n">CGPROGRAM</span>
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>            <span class="c1">// make fog work</span>
            <span class="cp">#pragma multi_compile_fog
</span>
            <span class="n">fixed4</span> <span class="n">frag</span> <span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
            <span class="p">{</span>
                <span class="c1">// sample the texture</span>
                <span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
                <span class="c1">// apply fog</span>
                <span class="n">UNITY_APPLY_FOG</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">fogCoord</span><span class="p">,</span> <span class="n">col</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">fixed4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">ENDCG</span>
        <span class="p">}</span>
        
        <span class="n">Pass</span>
        <span class="p">{</span>
            <span class="n">Stencil</span> <span class="p">{</span>
                <span class="n">Ref</span> <span class="mi">2</span>          <span class="c1">//0-255</span>
                <span class="n">Comp</span> <span class="n">Equal</span>     <span class="c1">//default:always</span>
                <span class="n">Pass</span> <span class="n">keep</span>      <span class="c1">//default:keep</span>
                <span class="n">Fail</span> <span class="n">keep</span>      <span class="c1">//default:keep</span>
                <span class="n">ZFail</span> <span class="n">keep</span>     <span class="c1">//default:keep</span>
            <span class="p">}</span>
            <span class="n">CGPROGRAM</span>
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>            <span class="c1">// make fog work</span>
            <span class="cp">#pragma multi_compile_fog
</span>            
            <span class="cp">#include "UnityCG.cginc"
</span>
            <span class="n">fixed4</span> <span class="n">frag</span> <span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
            <span class="p">{</span>
                <span class="c1">// sample the texture</span>
                <span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
                <span class="c1">// apply fog</span>
                <span class="n">UNITY_APPLY_FOG</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">fogCoord</span><span class="p">,</span> <span class="n">col</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">fixed4</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">ENDCG</span>
        <span class="p">}</span>

        <span class="n">Pass</span>
        <span class="p">{</span>
            <span class="n">Stencil</span> <span class="p">{</span>
                <span class="n">Ref</span> <span class="mi">3</span>          <span class="c1">//0-255</span>
                <span class="n">Comp</span> <span class="n">equal</span>     <span class="c1">//default:always</span>
                <span class="n">Pass</span> <span class="n">keep</span>      <span class="c1">//default:keep</span>
                <span class="n">Fail</span> <span class="n">keep</span>      <span class="c1">//default:keep</span>
                <span class="n">ZFail</span> <span class="n">keep</span>     <span class="c1">//default:keep</span>
            <span class="p">}</span>
            <span class="n">CGPROGRAM</span>
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>            <span class="c1">// make fog work</span>
            <span class="cp">#pragma multi_compile_fog
</span>            
            <span class="cp">#include "UnityCG.cginc"
</span>
            <span class="n">fixed4</span> <span class="n">frag</span> <span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
            <span class="p">{</span>
                <span class="c1">// sample the texture</span>
                <span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
                <span class="c1">// apply fog</span>
                <span class="n">UNITY_APPLY_FOG</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">fogCoord</span><span class="p">,</span> <span class="n">col</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">fixed4</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">ENDCG</span>
        <span class="p">}</span>

        <span class="n">Pass</span>
        <span class="p">{</span>
            <span class="n">Stencil</span> <span class="p">{</span>
                <span class="n">Ref</span> <span class="mi">4</span>          <span class="c1">//0-255</span>
                <span class="n">Comp</span> <span class="n">equal</span>     <span class="c1">//default:always</span>
                <span class="n">Pass</span> <span class="n">keep</span>      <span class="c1">//default:keep</span>
                <span class="n">Fail</span> <span class="n">keep</span>      <span class="c1">//default:keep</span>
                <span class="n">ZFail</span> <span class="n">keep</span>     <span class="c1">//default:keep</span>
            <span class="p">}</span>
            <span class="n">CGPROGRAM</span>
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>            <span class="c1">// make fog work</span>
            <span class="cp">#pragma multi_compile_fog
</span>            
            <span class="cp">#include "UnityCG.cginc"
</span>
            <span class="n">fixed4</span> <span class="n">frag</span> <span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
            <span class="p">{</span>
                <span class="c1">// sample the texture</span>
                <span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
                <span class="c1">// apply fog</span>
                <span class="n">UNITY_APPLY_FOG</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">fogCoord</span><span class="p">,</span> <span class="n">col</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">fixed4</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">ENDCG</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="remarks-1">Remarks</h2>

<p>This shader is similar to the example shader of “Red/Green/Blue” on the <a href="https://docs.unity3d.com/Manual/SL-Stencil.html">Unity website</a>, relying on the stencil buffer to differenciate the cross areas of the geometries.</p>

<p>Each pass has own stencil struct. In first pass all tests will be succeeded and add one to the stencil value of the rendered fragments. The next three passes will only render the field marked by the stencil value of 2, 3 and 4.</p>

<h2 id="the-resulting-screenshots-1">The resulting screenshots</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="https://res.cloudinary.com/dokdkay80/image/upload/v1604503676/StencilBuffer/p1_fddhcm.png" alt="placeholder" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><span style="color: gray; font-size: 80%">Picture 3: Using the PolygonsBeta.shader in the demo project</span></td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="https://res.cloudinary.com/dokdkay80/image/upload/v1604503676/StencilBuffer/p2_zkey5s.png" alt="placeholder" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><span style="color: gray; font-size: 80%">Picture 4: Using the polygons.shader in the demo project. The code of the Archimedean spiral comes from my <a href="https://blog.csdn.net/liu_if_else/article/details/51458603">previous article(Chinese)</a>. </span></td>
    </tr>
  </tbody>
</table>

<h1 id="mirror-restricting">Mirror Restricting</h1>

<h2 id="the-shader-snippets">The shader snippets</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Shader</span> <span class="s">"Unlit/TwoPassReflection"</span>
<span class="p">{</span>
	<span class="n">Properties</span>
	<span class="p">{</span>
		<span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Texture"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
	<span class="p">}</span>
	<span class="n">SubShader</span>
	<span class="p">{</span>
		<span class="n">Tags</span> <span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Opaque"</span> <span class="s">"Queue"</span><span class="o">=</span><span class="s">"Geometry"</span> <span class="p">}</span>
		<span class="n">LOD</span> <span class="mi">100</span>

		<span class="n">Pass</span>
		<span class="p">{</span>
			<span class="n">CGPROGRAM</span>
			<span class="cp">#pragma vertex vert
</span>			<span class="cp">#pragma fragment frag
</span>			<span class="c1">// make fog work</span>
			<span class="cp">#pragma multi_compile_fog
</span>			
			<span class="cp">#include "UnityCG.cginc"
</span>
			<span class="k">struct</span> <span class="n">appdata</span>
			<span class="p">{</span>
				<span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
				<span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
			<span class="p">};</span>

			<span class="k">struct</span> <span class="n">v2f</span>
			<span class="p">{</span>
				<span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
				<span class="n">UNITY_FOG_COORDS</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
			<span class="p">};</span>

			<span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
			<span class="n">float4</span> <span class="n">_MainTex_ST</span><span class="p">;</span>
			
			<span class="n">v2f</span> <span class="n">vert</span> <span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
				<span class="n">o</span><span class="p">.</span><span class="n">vertex</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
				<span class="n">o</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_MainTex</span><span class="p">);</span>
				<span class="n">UNITY_TRANSFER_FOG</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">o</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">o</span><span class="p">;</span>
			<span class="p">}</span>
			
			<span class="n">fixed4</span> <span class="n">frag</span> <span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
			<span class="p">{</span>
				<span class="c1">// sample the texture</span>
				<span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
				<span class="c1">// apply fog</span>
				<span class="n">UNITY_APPLY_FOG</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">fogCoord</span><span class="p">,</span> <span class="n">col</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">col</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ENDCG</span>
		<span class="p">}</span>

 		<span class="n">Pass</span>
 		<span class="p">{</span>
 		    <span class="n">Stencil</span> <span class="p">{</span>
 		        <span class="n">Ref</span> <span class="mi">1</span>          <span class="c1">//0-255</span>
 		        <span class="n">Comp</span> <span class="n">Equal</span>     <span class="c1">//default:always</span>
 		        <span class="n">Pass</span> <span class="n">keep</span>      <span class="c1">//default:keep</span>
 		        <span class="n">Fail</span> <span class="n">keep</span>      <span class="c1">//default:keep</span>
 		        <span class="n">ZFail</span> <span class="n">keep</span>     <span class="c1">//default:keep</span>
 		    <span class="p">}</span>
 		    <span class="n">ZTest</span> <span class="n">Always</span>
 		    <span class="n">CGPROGRAM</span>
 		    <span class="cp">#pragma vertex vert
</span> 		    <span class="cp">#pragma fragment frag
</span> 		    <span class="c1">// make fog work</span>
 		    <span class="cp">#pragma multi_compile_fog
</span> 		    
 		    <span class="cp">#include "UnityCG.cginc"
</span>
 		    <span class="k">struct</span> <span class="n">appdata</span>
 		    <span class="p">{</span>
 		        <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
 		        <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
 		        <span class="n">float4</span> <span class="n">normal</span><span class="o">:</span> <span class="n">NORMAL</span><span class="p">;</span>
 		    <span class="p">};</span>

 		    <span class="k">struct</span> <span class="n">v2f</span>
 		    <span class="p">{</span>
 		        <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
 		        <span class="n">UNITY_FOG_COORDS</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
 		        <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
 		    <span class="p">};</span>

 		    <span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
 		    <span class="n">float4</span> <span class="n">_MainTex_ST</span><span class="p">;</span>
 		    
 		    <span class="n">v2f</span> <span class="n">vert</span> <span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">)</span>
 		    <span class="p">{</span>
 		        <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
 		        <span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">.</span><span class="n">xyz</span><span class="o">=</span><span class="n">reflect</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">.</span><span class="n">xyz</span><span class="p">,</span><span class="n">float3</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">));</span>
 		        <span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">.</span><span class="n">xyz</span><span class="o">=</span><span class="n">reflect</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">.</span><span class="n">xyz</span><span class="p">,</span><span class="n">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">));</span>
 		        <span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">.</span><span class="n">x</span><span class="o">+=</span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="n">f</span><span class="p">;</span>
 		        <span class="n">o</span><span class="p">.</span><span class="n">vertex</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
 		        <span class="n">o</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_MainTex</span><span class="p">);</span>
 		        <span class="n">UNITY_TRANSFER_FOG</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">o</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
 		        <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
 		    <span class="p">}</span>
 		    
 		    <span class="n">fixed4</span> <span class="n">frag</span> <span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
 		    <span class="p">{</span>
 		        <span class="c1">// sample the texture</span>
 		        <span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
 		        <span class="c1">// apply fog</span>
 		        <span class="n">UNITY_APPLY_FOG</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">fogCoord</span><span class="p">,</span> <span class="n">col</span><span class="p">);</span>
 		        <span class="k">return</span> <span class="n">col</span><span class="p">;</span>
 		    <span class="p">}</span>
 		    <span class="n">ENDCG</span>
 		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Shader</span> <span class="s">"Unlit/Mirror"</span>
<span class="p">{</span>
	<span class="n">Properties</span>
	<span class="p">{</span>
		<span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Texture"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
	<span class="p">}</span>
	<span class="n">SubShader</span>
	<span class="p">{</span>
		<span class="n">Tags</span> <span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Opaque"</span> <span class="s">"Queue"</span><span class="o">=</span><span class="s">"Geometry-1"</span> <span class="p">}</span> <span class="c1">//you have to render the mirror first</span>
		<span class="n">LOD</span> <span class="mi">100</span>

 		<span class="n">Stencil</span> <span class="p">{</span>
 		    <span class="n">Ref</span> <span class="mi">0</span>          <span class="c1">//0-255</span>
 		    <span class="n">Comp</span> <span class="n">always</span>    <span class="c1">//default:always</span>
 		    <span class="n">Pass</span> <span class="n">IncrSat</span>   <span class="c1">//default:keep</span>
 		    <span class="n">Fail</span> <span class="n">keep</span>      <span class="c1">//default:keep</span>
 		    <span class="n">ZFail</span> <span class="n">keep</span>     <span class="c1">//default:keep</span>
 		<span class="p">}</span>

		<span class="n">Pass</span>
		<span class="p">{</span>
			<span class="n">CGPROGRAM</span>
			<span class="cp">#pragma vertex vert
</span>			<span class="cp">#pragma fragment frag
</span>			<span class="c1">// make fog work</span>
			<span class="cp">#pragma multi_compile_fog
</span>			
			<span class="cp">#include "UnityCG.cginc"
</span>
			<span class="k">struct</span> <span class="n">appdata</span>
			<span class="p">{</span>
				<span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
				<span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
			<span class="p">};</span>

			<span class="k">struct</span> <span class="n">v2f</span>
			<span class="p">{</span>
				<span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
				<span class="n">UNITY_FOG_COORDS</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
			<span class="p">};</span>

			<span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
			<span class="n">float4</span> <span class="n">_MainTex_ST</span><span class="p">;</span>
			
			<span class="n">v2f</span> <span class="n">vert</span> <span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
				<span class="n">o</span><span class="p">.</span><span class="n">vertex</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
				<span class="n">o</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_MainTex</span><span class="p">);</span>
				<span class="n">UNITY_TRANSFER_FOG</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">o</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">o</span><span class="p">;</span>
			<span class="p">}</span>
			
			<span class="n">fixed4</span> <span class="n">frag</span> <span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
			<span class="p">{</span>
				<span class="c1">// sample the texture</span>
				<span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
				<span class="c1">// apply fog</span>
				<span class="n">UNITY_APPLY_FOG</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">fogCoord</span><span class="p">,</span> <span class="n">col</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">fixed4</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ENDCG</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<h2 id="remarks-2">Remarks</h2>

<p>The Mirror shader assists the TwoPassReflection shader to correctly and concisely simulate the mirroring effect. In the TwoPassReflection shader, the first pass processes all vertices normally and the second pass will reflect them by change their position. The ZTest of the second pass must set to Always in case of a mirror object blocking the reflected fragments.</p>

<p>If you insert a flat plane between those reflected fragments, visually it becomes a mirror. However, this effect could be debunked if the mirror object doesn’t cover the whole reflected area(see picture 5 beneath).</p>

<p>The solution is to add the stencil test to the TwoPassReflection shader’s second pass, agreeing to only render to the fragments with stencil value of one, which should had been marked by the Mirror shader already.</p>

<h2 id="the-resulting-screenshots-2">The resulting screenshots</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="https://res.cloudinary.com/dokdkay80/image/upload/v1604503677/StencilBuffer/p7_lxi6i9.png" alt="placeholder" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><span style="color: gray; font-size: 80%; text-align: center">Picture 5: Using the TwoPassReflection.shader(without stencil test)</span></td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="https://res.cloudinary.com/dokdkay80/image/upload/v1604503678/StencilBuffer/p8_fmquxq.png" alt="placeholder" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><span style="color: gray; font-size: 80%; text-align: center">Picture 6: Using the TwoPassReflection.shader and the Mirror.shader</span></td>
    </tr>
  </tbody>
</table>

<h1 id="shadow-volume">Shadow Volume</h1>

<h2 id="the-shader-snippet-2">The shader snippet</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Shader</span> <span class="s">"Unlit/SV_DepthFailBeta"</span>
<span class="p">{</span>
    <span class="n">Properties</span>
    <span class="p">{</span>
    <span class="p">}</span>
    <span class="n">SubShader</span>
    <span class="p">{</span>
        <span class="n">Tags</span> <span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Opaque"</span> <span class="s">"Queue"</span><span class="o">=</span><span class="s">"Geometry+1"</span><span class="p">}</span>  <span class="c1">//delay the shadow geometry rendering</span>
        <span class="n">LOD</span> <span class="mi">100</span>
        
        <span class="n">CGINCLUDE</span>       <span class="c1">//three passes have the same vertex and fragment shaders</span>
        <span class="cp">#include "UnityCG.cginc"
</span>        <span class="k">struct</span> <span class="n">appdata</span>
        <span class="p">{</span>
            <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="k">struct</span> <span class="n">v2f</span>
        <span class="p">{</span>
            <span class="n">UNITY_FOG_COORDS</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="n">v2f</span> <span class="n">vert</span> <span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
            <span class="n">o</span><span class="p">.</span><span class="n">vertex</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
            <span class="n">UNITY_TRANSFER_FOG</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">o</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">fixed4</span> <span class="n">frag</span> <span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
        <span class="p">{</span>
            <span class="c1">// apply fog</span>
            <span class="n">UNITY_APPLY_FOG</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">fogCoord</span><span class="p">,</span> <span class="n">col</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">fixed4</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>           <span class="c1">//the color of the shadow</span>
        <span class="p">}</span>
        <span class="n">ENDCG</span>

        <span class="n">Pass</span>
        <span class="p">{</span>
            <span class="n">Cull</span> <span class="n">Front</span>          <span class="c1">//first pass renders the inside surface</span>
            <span class="n">Stencil</span> <span class="p">{</span>           
                <span class="n">Ref</span> <span class="mi">0</span>           <span class="c1">//0-255</span>
                <span class="n">Comp</span> <span class="n">always</span>     <span class="c1">//default:always</span>
                <span class="n">Pass</span> <span class="n">keep</span>       <span class="c1">//default:keep</span>
                <span class="n">Fail</span> <span class="n">keep</span>       <span class="c1">//default:keep</span>
                <span class="n">ZFail</span> <span class="n">IncrWrap</span>  <span class="c1">//default:keep</span>
            <span class="p">}</span>

            <span class="n">ColorMask</span> <span class="mi">0</span>         <span class="c1">//don't have to touch the color buffer</span>
            <span class="n">CGPROGRAM</span>
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>            <span class="c1">// make fog work</span>
            <span class="cp">#pragma multi_compile_fog
</span>            <span class="n">ENDCG</span>
        <span class="p">}</span>
        
        <span class="n">Pass</span>
        <span class="p">{</span>
            <span class="n">Cull</span> <span class="n">Back</span>           <span class="c1">//second pass renders the outside surface</span>
            <span class="n">Stencil</span> <span class="p">{</span>
                <span class="n">Ref</span> <span class="mi">0</span>           <span class="c1">//0-255</span>
                <span class="n">Comp</span> <span class="n">always</span>     <span class="c1">//default:always</span>
                <span class="n">Pass</span> <span class="n">keep</span>       <span class="c1">//default:keep</span>
                <span class="n">Fail</span> <span class="n">keep</span>       <span class="c1">//default:keep</span>
                <span class="n">ZFail</span> <span class="n">DecrWrap</span>  <span class="c1">//default:keep</span>
            <span class="p">}</span>
            <span class="n">ColorMask</span> <span class="mi">0</span>         <span class="c1">//no writing to color buffer</span>
            <span class="n">CGPROGRAM</span>
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>            <span class="c1">// make fog work</span>
            <span class="cp">#pragma multi_compile_fog
</span>            <span class="n">ENDCG</span>
        <span class="p">}</span>

        <span class="n">Pass</span>
        <span class="p">{</span>
            <span class="n">Cull</span> <span class="n">Back</span>          <span class="c1">//identify the shadow fragments</span>
            <span class="n">Stencil</span> <span class="p">{</span>
                <span class="n">Ref</span> <span class="mi">1</span>          <span class="c1">//0-255</span>
                <span class="n">Comp</span> <span class="n">equal</span>     <span class="c1">//default:always</span>
                <span class="n">Pass</span> <span class="n">keep</span>      <span class="c1">//default:keep</span>
                <span class="n">Fail</span> <span class="n">keep</span>      <span class="c1">//default:keep</span>
                <span class="n">ZFail</span> <span class="n">keep</span>     <span class="c1">//default:keep</span>
            <span class="p">}</span>
            <span class="n">CGPROGRAM</span>
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>            <span class="c1">// make fog work</span>
            <span class="cp">#pragma multi_compile_fog
</span>            <span class="n">ENDCG</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="remarks-3">Remarks</h2>

<p>The idea of shadow volume is to instaniate the shadow as a geometry(see the selected cylinder object in picture 7) and then to identify all the shadow fragments in the rendering process of this geometry.</p>

<p>There are several algorithms to derterminate the shadow fragments. The demo shader has used “Depth Fail”, which also names as “Carmack’s reverse”. From the perspective of stencil buffer, I have simplified it by three steps:</p>

<p>1, Render all common objects, like ground, trees and etc., first and then the shadow object. The first pass of the shadow object’s shader will “cull front”, rendering the inside surface of the shadow geometry. The stencil test of the first pass will increase the stencil value of the Z-test-failed fragments, which could be blocked by the common objects inside the shadow geometry. It’s also possible that the Z-test failure were caused by the blocking of objects outside the shadow geometry. In this case, these fragments’ stencil value were wrongly increased. But it’s temporarily, we will solve it in step 2.</p>

<p>2, Setting “cull back”, the second pass renders the outside surface of the shadow geometry. After the rasterization, the fragments can not be blocked by the objects inside the shadow geometry but can still be blocked by the objects outside. When these Z-test-failed fragments were found, the “ZFail DecrWrap” operation will decrease their stencil value by one.</p>

<p>3, Consequently, the fragments of the common objects inside the shadow geometry have the stencil value of 1. The correct shadow will be generated by rendering these pixels.</p>

<p>From theory to practice, the three steps above have also explained what happened in the shader’s three passes.</p>

<p>Actually, this single shader is not sufficient to implement shadow volume. For instance, the appropriate shadow geometry, imported model or generated in the runtime, is a must. Some details such as other shadows in the shadow geometry were not discussed. Nonetheless, the shader illustrates well the stencil buffer’s important role of putting this rendering technique into effect.</p>

<h2 id="the-resulting-screenshots-3">The resulting screenshots</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="https://res.cloudinary.com/dokdkay80/image/upload/v1604503678/StencilBuffer/p5_ts0u94.png" alt="placeholder" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><span style="color: gray; font-size: 80%; text-align: center">Picture 7: Using the SV_DepthFailBeta.shader and selecting the cylinder shadow geometry</span></td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="https://res.cloudinary.com/dokdkay80/image/upload/v1604503678/StencilBuffer/p4_lf3jzw.png" alt="placeholder" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><span style="color: gray; font-size: 80%; text-align: center">Picture 8: Using the SV_DepthFailBeta.shader in the demo project</span></td>
    </tr>
  </tbody>
</table>

<hr />
<p><strong>Github Link of the demo project:</strong> <br />
<a href="https://github.com/liu-if-else/UnityStencilBufferUses">https://github.com/liu-if-else/UnityStencilBufferUses</a></p>

<hr />
<p><strong>References:</strong></p>

<p>Shadow Volume–Depth Fail - wikipedia<br />
<a href="https://en.wikipedia.org/wiki/Shadow_volume#Depth_fail">https://en.wikipedia.org/wiki/Shadow_volume#Depth_fail</a></p>

<p>Creating Reflections and Shadows Using Stencil - BuffersMark J. Kilgard<br />
<a href="https://www2.cs.duke.edu/courses/spring15/cps124/classwork/14_buffers/stencil.pdf">https://www2.cs.duke.edu/courses/spring15/cps124/classwork/14_buffers/stencil.pdf</a></p>

<p>Stencil Shadow Volume - OGL<br />
<a href="http://ogldev.atspace.co.uk/www/tutorial40/tutorial40.html">http://ogldev.atspace.co.uk/www/tutorial40/tutorial40.html</a></p>

<p>ShaderLab: Stencil - Unity Technology<br />
<a href=" https://docs.unity3d.com/Manual/SL-Stencil.html"> https://docs.unity3d.com/Manual/SL-Stencil.html</a></p>

<p>Simon F’s answer to topic of ‘Uses for Stencil Buffer’ - Simon F<br />
<a href=" https://computergraphics.stackexchange.com/questions/5046/uses-for-stencil-buffer"> https://computergraphics.stackexchange.com/questions/5046/uses-for-stencil-buffer</a></p>

<hr />
<p><strong>The Chinese version of this articel:</strong><br />
<a href="https://blog.csdn.net/liu_if_else/article/details/86316361 ">https://blog.csdn.net/liu_if_else/article/details/86316361</a></p>



                <!-- Pagination links -->


            </article>

            

        </section>

        <!-- Add time bar only for pages without pagination -->
        
            <div class="time-bar" data-minutes="24">
    <span class="time-completed"></span>
    <span class="time-remaining"></span>
    <div class="bar">
        <span class="completed" style="width:0%;"></span>
        <span class="remaining" style="width:100%;"></span>
    </div>
</div>

            <div class="recommendation">
    <div class="message">
        <strong>Why don't you read something next?</strong>
        <div>
            <button>
                <svg><use xlink:href="#icon-arrow-right"></use></svg>
                <span>Go back to top</span>
            </button>
        </div>
    </div>
    
    <a href="/unity3d-audio-visualizer/" class="post-preview">
        <div class="image">
            
                <img src="https://res.cloudinary.com/dokdkay80/image/upload/c_scale,w_380/v1604498366/AudioVisualizer/av1_itqijr.png">
            
        </div>
        <h3 class="title">Unity3D Audio Visualizer</h3>
    </a>
</div>

        

        <!-- Show modal if the post is the last one -->
        

        <!-- Show modal before user leaves the page -->
        

        <!-- Add your newsletter subscription form here -->

        <section class="share">
    <h3>Share</h3>
    <a aria-label="Share on Twitter" href="https://twitter.com/intent/tweet?text=&quot;Demonstrate the uses of Unity Stencil Buffer with outlining, polygon filling, mirror restricting and shadow volume.&quot;%20http://localhost:4000/stencil-buffer's-uses-in-unity3d/%20via%20&#64;twitter_username&hashtags=Shader,Unity3D,"
    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter">
        <svg class="icon icon-twitter"><use xlink:href="#icon-twitter"></use></svg>
    </a>
    <a aria-label="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/stencil-buffer's-uses-in-unity3d/"
    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook">
        <svg class="icon icon-facebook"><use xlink:href="#icon-facebook"></use></svg>
    </a>
</section>

        

  <section class="author">
    <div class="details">
      
        <img class="img-rounded" src="/assets/img/uploads/profile.png" alt="liu_if_else">
      
      <p class="def">Author</p>
      <h3 class="name">
        <a href="/authors/liu_if_else/">liu_if_else</a>
      </h3>
      <p class="desc">Nothing to say.</p>
      <p>
        
          <a href="https://github.com/liu-if-else" title="Github">
            <svg><use xlink:href="#icon-github"></use></svg>
          </a>
        
        
        
        
        
        
      </p>
    </div>
  </section>

  
  
  
  
  
  
  

  <script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "liu_if_else",
      
      "image": "/assets/img/uploads/profile.png",
      
      "jobTitle": "Blogger",
      "url": "http://localhost:4000/authors/liu_if_else/",
      "sameAs": [
        "https://github.com/liu-if-else"
      ]
  }
  </script>


        

<section class="comments">
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
    <style>
        .utterances{z-index:-1;}
    </style>
</section>

<script src="https://utteranc.es/client.js"
    repo="liu-if-else/liu-if-else.github.io"
    issue-term="pathname"
    theme="github-light"
    lable="💬comment"
    crossorigin="anonymous"
    async>
</script>

<!--script type="text/javascript">
    var disqus_loaded = false;

    function load_disqus()
    {
        disqus_loaded = true;
        var disqus_shortname = 'liu-if-else';
        var disqus_title = '';
        var disqus_url = '/stencil-buffer's-uses-in-unity3d/';
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        var ldr = document.getElementById('disqus_loader');
    };
    window.onscroll = function(e) {
        if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 800)) {
            //hit bottom of page
            if (disqus_loaded==false)
                load_disqus()
        }
    };
</script-->


        <footer>
    <p>
      
        <a href="https://github.com/liu-if-else" title="Github">
          <svg><use xlink:href="#icon-github"></use></svg>
        </a>
      
      
        <!--a href="https://www.facebook.com/facebook_username" title="Facebook"-->
        <a>
          <svg><use xlink:href="#icon-facebook"></use></svg>
        </a>
      
      
        <!--a href="https://twitter.com/twitter_username" title="Twitter"-->
        <a>
          <svg><use xlink:href="#icon-twitter"></use></svg>
        </a>
      
      
        <!--a href="https://medium.com/@medium_username" title="Medium"-->
        <a>
          <svg><use xlink:href="#icon-medium"></use></svg>
        </a>
      
      
        <!--a href="https://www.instagram.com/instagram_username" title="Instagram"-->
        <a>
          <svg><use xlink:href="#icon-instagram"></use></svg>
        </a>
      
      
        <!--a href="https://www.linkedin.com/in/linkedin_username" title="LinkedIn"-->
        <a>
          <svg><use xlink:href="#icon-linkedin"></use></svg>
        </a>
      
    </p>

    <ul>
  
    
      <li>
        <a href="http://localhost:4000/">Home</a>
      </li>
    
  
    
      <li>
        <a href="http://localhost:4000/about">About</a>
      </li>
    
  
    
      <li>
        <a href="http://localhost:4000/contact">Contact</a>
      </li>
    
  
    
      <li>
        <a href="http://localhost:4000/feed.xml">Feed</a>
      </li>
    
  
</ul>

    <!--p>
      <span>Jekflix</span> was made with <svg class="love"><use xlink:href="#icon-heart"></use></svg> by <a href="https://rossener.com" target="_blank" class="creator">Thiago Rossener</a>
    </p-->
    <p>
      Power by <span>Github Pages</span>, <span>Jekyll</span>, and <span>Jetflix</span>
    </p>
</footer>









<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "liu_if_else's blog",
  "description": "A tech blog focusing on game programming and Unity3D.",
  "url": "http://localhost:4000/",
  "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:4000/assets/img/icons/mediumtile.png",
      "width": "600",
      "height": "315"
  },
  "sameAs": [
    "https://github.com/liu-if-else","https://www.facebook.com/facebook_username","https://twitter.com/twitter_username","https://medium.com/@medium_username","https://www.instagram.com/instagram_username","https://www.linkedin.com/in/linkedin_username"
  ]
}
</script>

<!-- Include the script that allows Netlify CMS login -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<!-- Include the website scripts -->
<script src="/assets/js/scripts.min.js"></script>

<!-- Include Google Analytics script -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXXX-X"></script>
<script>
  var host = window.location.hostname;
  if (host != 'localhost') {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-XXXXXXXX-X');
  }
</script>
  


<!-- Include extra scripts -->



        

        
        
        
        
        
        
        
        
        <script>
            MathJax = {
                tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
        </script>
        
        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "BlogPosting",
            "name": "Stencil Buffer's Uses in Unity3D",
            "headline": "Outlining, polygon filling, mirror restricting and shadow volume.",
            "description": "Demonstrate the uses of Unity Stencil Buffer with outlining, polygon filling, mirror restricting and shadow volume.",
            "image": "https://res.cloudinary.com/dokdkay80/image/upload/c_scale,w_760/v1604503676/StencilBuffer/p1_fddhcm.png",
            "url": "http://localhost:4000/stencil-buffer's-uses-in-unity3d/",
            "articleBody": "Menu

  The stencil buffer
    
      The stencil
      Stencil and depth buffer
      Reading and writing
    
  
  Outlining
    
      The shader snippet
      Remarks
      The resulting screenshots
    
  
  Polygon Filling
    
      The shader snippet
      Remarks
      The resulting screenshots
    
  
  Mirror Restricting
    
      The shader snippets
      Remarks
      The resulting screenshots
    
  
  Shadow Volume
    
      The shader snippet
      Remarks
      The resulting screenshots
    
  


The stencil buffer

The stencil

A stencil is a flat material where parts, usually shapes or patterns, have been cutted out. It’s a common and traditional tool used by many industries such as printing, clothing, painting and etc. Through those holes, you draw or paint the desired images on the surface below the stencil.

If you imagine the computer screen as a x*y matrix of 0, the stencil buffer decides the shape of the holes by setting parts of those zeros to 1,2,3,…, and 255. In each pass of the shader, all the operations are filtered by the pre-setting stencil value. The pixels will be discarded if they don’t have that stencil number. In this way, the stencil buffer becomes a mask and the render texture the paper under it.

Stencil and depth buffer

According to the Wikipedia, the very modern GPU architecture binds the stencil and depth buffer together. For instance, in a continuous 32 bits area of the Graphics RAM, there could be 24 bits for depth buffer and 8 bits for stencil buffer of a fragment. When you create a render-texture in Unity, setting RenderTexture.depth to 32 will enable a 8 bits stencil buffer while 16(and 24?) will disable it. Maybe because of they are so close together, you can actually get the Z-test result in the stencil testing.

Reading and writing

In the OpenGL pipeline, between the fragment shader and the Blending, there are three testing stages that are scissor testing, stencil testing and Z-testing. All these testing operations have the OpenGL state machine style syntax, which is all about pre-setting and keywords.

For stencil test, you need to firstly declar a Stencil structure in SubShader or Pass scope, and then use “Ref” to set a base stencil value to compare, “Comp” to set a comparing condition, “Pass” to determine the furthur operation if the comparetion successes, “Fail” in the opposite scenario, and “ZFail” if the comparetion successes but depth test fails. All the comparison functions and stencil operation keywords can be found at Unity documentation.

Stencil {
    //the base value to compare with
    Ref 0           //value's range: 0-255
    //compare condition
    Comp Equal     //default keyword: always(always pass)
    //the furthur operation if the comparetion successes
    Pass keep       //default keyword: keep(keep the fragment's current stencil value)
    //the furthur operation if the comparetion fails
    Fail keep       //default keyword: keep
    //if the stencil comparetion successes but Z-test fails
    ZFail IncrWrap  //default keyword: keep
}


Outlining

The shader snippet

Shader &quot;Unlit/StentilOutline&quot;
{
	Properties
	{
		_MainTex (&quot;Texture&quot;, 2D) = &quot;white&quot; {}
	}
	SubShader
	{
		Tags { &quot;RenderType&quot;=&quot;Opaque&quot; }
		LOD 100
		Stencil {
		     Ref 0          //0-255
		     Comp Equal     //default:always
		     Pass IncrSat   //default:keep
		     Fail keep      //default:keep
		     ZFail keep     //default:keep
		}

		Pass
		{
			CGPROGRAM
			#pragma vertex vert
			#pragma fragment frag
			// make fog work
			#pragma multi_compile_fog
			
			#include &quot;UnityCG.cginc&quot;

			struct appdata
			{
				float4 vertex : POSITION;
				float2 uv : TEXCOORD0;
			};

			struct v2f
			{
				float2 uv : TEXCOORD0;
				UNITY_FOG_COORDS(1)
				float4 vertex : SV_POSITION;
			};

			sampler2D _MainTex;
			float4 _MainTex_ST;
			
			v2f vert (appdata v)
			{
				v2f o;
				o.vertex = UnityObjectToClipPos(v.vertex);
				o.uv = TRANSFORM_TEX(v.uv, _MainTex);
				UNITY_TRANSFER_FOG(o,o.vertex);
				return o;
			}
			
			fixed4 frag (v2f i) : SV_Target
			{
				// sample the texture
				fixed4 col = tex2D(_MainTex, i.uv);
				// apply fog
				UNITY_APPLY_FOG(i.fogCoord, col);
				//return fixed4(1,1,0,1);
				return col;
			}
			ENDCG
		}

		Pass
		{
		    CGPROGRAM
		    #pragma vertex vert
		    #pragma fragment frag
		    // make fog work
		    #pragma multi_compile_fog
		    
		    #include &quot;UnityCG.cginc&quot;

		    struct appdata
		    {
		        float4 vertex : POSITION;
		        float4 normal: NORMAL;
		        float2 uv : TEXCOORD0;
		    };

		    struct v2f
		    {
		        float2 uv : TEXCOORD0;
		        UNITY_FOG_COORDS(1)
		        float4 vertex : SV_POSITION;
		    };

		    sampler2D _MainTex;
		    float4 _MainTex_ST;
		    
		    v2f vert (appdata v)
		    {
		        v2f o;
		        o.vertex=v.vertex+normalize(v.normal)*0.01f;
		        o.vertex = UnityObjectToClipPos(o.vertex);
		        o.uv = TRANSFORM_TEX(v.uv, _MainTex);
		        UNITY_TRANSFER_FOG(o,o.vertex);
		        return o;
		    }
		    
		    fixed4 frag (v2f i) : SV_Target
		    {
		        // sample the texture
		        fixed4 col = tex2D(_MainTex, i.uv);
		        // apply fog
		        UNITY_APPLY_FOG(i.fogCoord, col);
		        return fixed4(1,1,1,1);
		    }
		    ENDCG
		}
	}
}


Remarks

		Stencil {
		     Ref 0          //0-255
		     Comp Equal     //default:always
		     Pass IncrSat   //default:keep
		     Fail keep      //default:keep
		     ZFail keep     //default:keep
		}

The struct has writen in the SubShader scope so it works for all passes. In the first pass, under the ideal condition, all rasterized fragments will pass the “Ref 0” and “Comp Equal” test since zero is the initial stencil value. Then “Pass IncrSat” will add one to the stencil value of passed fragments. “Sat” makes the addition in the saturation style which means that if the value was 255 then it stays 255.

...
		        o.vertex=v.vertex+normalize(v.normal)*0.01f;
...		       


In the second pass, verteces were magnified alone their normal direction at first. Most of the later rasterized fragments would be discarded since their stencil value is already one and could not pass the “Ref 0” and “Comp Equal” test. On the other hand, the stencil value of the fragments in the inflated area is still the initial value of zero thus they would succeed the test.

...
                return fixed4(1,1,1,1);
...


Color these fragments and you get the rim.

The resulting screenshots


  
    
      
    
  
  
    
      Picture 1: Using the StencilPerPassOutline.shader in the demo project
    
  



  
    
      
    
  
  
    
      Picture 2: Using the StencilOutline.shader in the demo project
    
  


Polygon Filling

The shader snippet

Shader &quot;Unlit/PolygonsBeta&quot;
{
    Properties
    {
        _MainTex (&quot;Texture&quot;, 2D) = &quot;white&quot; {}
    }
    SubShader
    {
        Tags { &quot;RenderType&quot;=&quot;Opaque&quot; }
        LOD 100

        CGINCLUDE
        #include &quot;UnityCG.cginc&quot;
        struct appdata
        {
            float4 vertex : POSITION;
            float2 uv : TEXCOORD0;
        };

        struct v2f
        {
            float2 uv : TEXCOORD0;
            UNITY_FOG_COORDS(1)
            float4 vertex : SV_POSITION;
        };

        sampler2D _MainTex;
        float4 _MainTex_ST;
        
        v2f vert (appdata v)
        {
            v2f o;
            o.vertex = UnityObjectToClipPos(v.vertex);
            o.uv = TRANSFORM_TEX(v.uv, _MainTex);
            UNITY_TRANSFER_FOG(o,o.vertex);
            return o;
        }
        ENDCG

        Pass
        {
            Stencil {
                Ref 0           //0-255
                Comp always     //default:always
                Pass IncrWrap   //default:keep
                Fail keep       //default:keep
                ZFail IncrWrap  //default:keep
            }

            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            // make fog work
            #pragma multi_compile_fog

            fixed4 frag (v2f i) : SV_Target
            {
                // sample the texture
                fixed4 col = tex2D(_MainTex, i.uv);
                // apply fog
                UNITY_APPLY_FOG(i.fogCoord, col);
                return fixed4(0,0,0,0);
            }
            ENDCG
        }
        
        Pass
        {
            Stencil {
                Ref 2          //0-255
                Comp Equal     //default:always
                Pass keep      //default:keep
                Fail keep      //default:keep
                ZFail keep     //default:keep
            }
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            // make fog work
            #pragma multi_compile_fog
            
            #include &quot;UnityCG.cginc&quot;

            fixed4 frag (v2f i) : SV_Target
            {
                // sample the texture
                fixed4 col = tex2D(_MainTex, i.uv);
                // apply fog
                UNITY_APPLY_FOG(i.fogCoord, col);
                return fixed4(0.2,0.2,0.2,1);
            }
            ENDCG
        }

        Pass
        {
            Stencil {
                Ref 3          //0-255
                Comp equal     //default:always
                Pass keep      //default:keep
                Fail keep      //default:keep
                ZFail keep     //default:keep
            }
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            // make fog work
            #pragma multi_compile_fog
            
            #include &quot;UnityCG.cginc&quot;

            fixed4 frag (v2f i) : SV_Target
            {
                // sample the texture
                fixed4 col = tex2D(_MainTex, i.uv);
                // apply fog
                UNITY_APPLY_FOG(i.fogCoord, col);
                return fixed4(0.6,0.6,0.6,1);
            }
            ENDCG
        }

        Pass
        {
            Stencil {
                Ref 4          //0-255
                Comp equal     //default:always
                Pass keep      //default:keep
                Fail keep      //default:keep
                ZFail keep     //default:keep
            }
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            // make fog work
            #pragma multi_compile_fog
            
            #include &quot;UnityCG.cginc&quot;

            fixed4 frag (v2f i) : SV_Target
            {
                // sample the texture
                fixed4 col = tex2D(_MainTex, i.uv);
                // apply fog
                UNITY_APPLY_FOG(i.fogCoord, col);
                return fixed4(1,1,1,1);
            }
            ENDCG
        }
    }
}


Remarks

This shader is similar to the example shader of “Red/Green/Blue” on the Unity website, relying on the stencil buffer to differenciate the cross areas of the geometries.

Each pass has own stencil struct. In first pass all tests will be succeeded and add one to the stencil value of the rendered fragments. The next three passes will only render the field marked by the stencil value of 2, 3 and 4.

The resulting screenshots


  
    
      
    
  
  
    
      Picture 3: Using the PolygonsBeta.shader in the demo project
    
  



  
    
      
    
  
  
    
      Picture 4: Using the polygons.shader in the demo project. The code of the Archimedean spiral comes from my previous article(Chinese). 
    
  


Mirror Restricting

The shader snippets

Shader &quot;Unlit/TwoPassReflection&quot;
{
	Properties
	{
		_MainTex (&quot;Texture&quot;, 2D) = &quot;white&quot; {}
	}
	SubShader
	{
		Tags { &quot;RenderType&quot;=&quot;Opaque&quot; &quot;Queue&quot;=&quot;Geometry&quot; }
		LOD 100

		Pass
		{
			CGPROGRAM
			#pragma vertex vert
			#pragma fragment frag
			// make fog work
			#pragma multi_compile_fog
			
			#include &quot;UnityCG.cginc&quot;

			struct appdata
			{
				float4 vertex : POSITION;
				float2 uv : TEXCOORD0;
			};

			struct v2f
			{
				float2 uv : TEXCOORD0;
				UNITY_FOG_COORDS(1)
				float4 vertex : SV_POSITION;
			};

			sampler2D _MainTex;
			float4 _MainTex_ST;
			
			v2f vert (appdata v)
			{
				v2f o;
				o.vertex = UnityObjectToClipPos(v.vertex);
				o.uv = TRANSFORM_TEX(v.uv, _MainTex);
				UNITY_TRANSFER_FOG(o,o.vertex);
				return o;
			}
			
			fixed4 frag (v2f i) : SV_Target
			{
				// sample the texture
				fixed4 col = tex2D(_MainTex, i.uv);
				// apply fog
				UNITY_APPLY_FOG(i.fogCoord, col);
				return col;
			}
			ENDCG
		}

 		Pass
 		{
 		    Stencil {
 		        Ref 1          //0-255
 		        Comp Equal     //default:always
 		        Pass keep      //default:keep
 		        Fail keep      //default:keep
 		        ZFail keep     //default:keep
 		    }
 		    ZTest Always
 		    CGPROGRAM
 		    #pragma vertex vert
 		    #pragma fragment frag
 		    // make fog work
 		    #pragma multi_compile_fog
 		    
 		    #include &quot;UnityCG.cginc&quot;

 		    struct appdata
 		    {
 		        float4 vertex : POSITION;
 		        float2 uv : TEXCOORD0;
 		        float4 normal: NORMAL;
 		    };

 		    struct v2f
 		    {
 		        float2 uv : TEXCOORD0;
 		        UNITY_FOG_COORDS(1)
 		        float4 vertex : SV_POSITION;
 		    };

 		    sampler2D _MainTex;
 		    float4 _MainTex_ST;
 		    
 		    v2f vert (appdata v)
 		    {
 		        v2f o;
 		        v.vertex.xyz=reflect(v.vertex.xyz,float3(-1.0f,0.0f,0.0f));
 		        v.vertex.xyz=reflect(v.vertex.xyz,float3(0.0f,1.0f,0.0f));
 		        v.vertex.x+=1.5f;
 		        o.vertex = UnityObjectToClipPos(v.vertex);
 		        o.uv = TRANSFORM_TEX(v.uv, _MainTex);
 		        UNITY_TRANSFER_FOG(o,o.vertex);
 		        return o;
 		    }
 		    
 		    fixed4 frag (v2f i) : SV_Target
 		    {
 		        // sample the texture
 		        fixed4 col = tex2D(_MainTex, i.uv);
 		        // apply fog
 		        UNITY_APPLY_FOG(i.fogCoord, col);
 		        return col;
 		    }
 		    ENDCG
 		}
	}
}

Shader &quot;Unlit/Mirror&quot;
{
	Properties
	{
		_MainTex (&quot;Texture&quot;, 2D) = &quot;white&quot; {}
	}
	SubShader
	{
		Tags { &quot;RenderType&quot;=&quot;Opaque&quot; &quot;Queue&quot;=&quot;Geometry-1&quot; } //you have to render the mirror first
		LOD 100

 		Stencil {
 		    Ref 0          //0-255
 		    Comp always    //default:always
 		    Pass IncrSat   //default:keep
 		    Fail keep      //default:keep
 		    ZFail keep     //default:keep
 		}

		Pass
		{
			CGPROGRAM
			#pragma vertex vert
			#pragma fragment frag
			// make fog work
			#pragma multi_compile_fog
			
			#include &quot;UnityCG.cginc&quot;

			struct appdata
			{
				float4 vertex : POSITION;
				float2 uv : TEXCOORD0;
			};

			struct v2f
			{
				float2 uv : TEXCOORD0;
				UNITY_FOG_COORDS(1)
				float4 vertex : SV_POSITION;
			};

			sampler2D _MainTex;
			float4 _MainTex_ST;
			
			v2f vert (appdata v)
			{
				v2f o;
				o.vertex = UnityObjectToClipPos(v.vertex);
				o.uv = TRANSFORM_TEX(v.uv, _MainTex);
				UNITY_TRANSFER_FOG(o,o.vertex);
				return o;
			}
			
			fixed4 frag (v2f i) : SV_Target
			{
				// sample the texture
				fixed4 col = tex2D(_MainTex, i.uv);
				// apply fog
				UNITY_APPLY_FOG(i.fogCoord, col);
				return fixed4(0.2f,0.2f,0.2f,1.0f);
			}
			ENDCG
		}
	}
}

Remarks

The Mirror shader assists the TwoPassReflection shader to correctly and concisely simulate the mirroring effect. In the TwoPassReflection shader, the first pass processes all vertices normally and the second pass will reflect them by change their position. The ZTest of the second pass must set to Always in case of a mirror object blocking the reflected fragments.

If you insert a flat plane between those reflected fragments, visually it becomes a mirror. However, this effect could be debunked if the mirror object doesn’t cover the whole reflected area(see picture 5 beneath).

The solution is to add the stencil test to the TwoPassReflection shader’s second pass, agreeing to only render to the fragments with stencil value of one, which should had been marked by the Mirror shader already.

The resulting screenshots


  
    
      
    
  
  
    
      Picture 5: Using the TwoPassReflection.shader(without stencil test)
    
  



  
    
      
    
  
  
    
      Picture 6: Using the TwoPassReflection.shader and the Mirror.shader
    
  


Shadow Volume

The shader snippet

Shader &quot;Unlit/SV_DepthFailBeta&quot;
{
    Properties
    {
    }
    SubShader
    {
        Tags { &quot;RenderType&quot;=&quot;Opaque&quot; &quot;Queue&quot;=&quot;Geometry+1&quot;}  //delay the shadow geometry rendering
        LOD 100
        
        CGINCLUDE       //three passes have the same vertex and fragment shaders
        #include &quot;UnityCG.cginc&quot;
        struct appdata
        {
            float4 vertex : POSITION;
        };

        struct v2f
        {
            UNITY_FOG_COORDS(1)
            float4 vertex : SV_POSITION;
        };

        v2f vert (appdata v)
        {
            v2f o;
            o.vertex = UnityObjectToClipPos(v.vertex);
            UNITY_TRANSFER_FOG(o,o.vertex);
            return o;
        }
        
        fixed4 frag (v2f i) : SV_Target
        {
            // apply fog
            UNITY_APPLY_FOG(i.fogCoord, col);
            return fixed4(0.3,0.3,0.3,1);           //the color of the shadow
        }
        ENDCG

        Pass
        {
            Cull Front          //first pass renders the inside surface
            Stencil {           
                Ref 0           //0-255
                Comp always     //default:always
                Pass keep       //default:keep
                Fail keep       //default:keep
                ZFail IncrWrap  //default:keep
            }

            ColorMask 0         //don't have to touch the color buffer
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            // make fog work
            #pragma multi_compile_fog
            ENDCG
        }
        
        Pass
        {
            Cull Back           //second pass renders the outside surface
            Stencil {
                Ref 0           //0-255
                Comp always     //default:always
                Pass keep       //default:keep
                Fail keep       //default:keep
                ZFail DecrWrap  //default:keep
            }
            ColorMask 0         //no writing to color buffer
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            // make fog work
            #pragma multi_compile_fog
            ENDCG
        }

        Pass
        {
            Cull Back          //identify the shadow fragments
            Stencil {
                Ref 1          //0-255
                Comp equal     //default:always
                Pass keep      //default:keep
                Fail keep      //default:keep
                ZFail keep     //default:keep
            }
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            // make fog work
            #pragma multi_compile_fog
            ENDCG
        }
    }
}


Remarks

The idea of shadow volume is to instaniate the shadow as a geometry(see the selected cylinder object in picture 7) and then to identify all the shadow fragments in the rendering process of this geometry.

There are several algorithms to derterminate the shadow fragments. The demo shader has used “Depth Fail”, which also names as “Carmack’s reverse”. From the perspective of stencil buffer, I have simplified it by three steps:

1, Render all common objects, like ground, trees and etc., first and then the shadow object. The first pass of the shadow object’s shader will “cull front”, rendering the inside surface of the shadow geometry. The stencil test of the first pass will increase the stencil value of the Z-test-failed fragments, which could be blocked by the common objects inside the shadow geometry. It’s also possible that the Z-test failure were caused by the blocking of objects outside the shadow geometry. In this case, these fragments’ stencil value were wrongly increased. But it’s temporarily, we will solve it in step 2.

2, Setting “cull back”, the second pass renders the outside surface of the shadow geometry. After the rasterization, the fragments can not be blocked by the objects inside the shadow geometry but can still be blocked by the objects outside. When these Z-test-failed fragments were found, the “ZFail DecrWrap” operation will decrease their stencil value by one.

3, Consequently, the fragments of the common objects inside the shadow geometry have the stencil value of 1. The correct shadow will be generated by rendering these pixels.

From theory to practice, the three steps above have also explained what happened in the shader’s three passes.

Actually, this single shader is not sufficient to implement shadow volume. For instance, the appropriate shadow geometry, imported model or generated in the runtime, is a must. Some details such as other shadows in the shadow geometry were not discussed. Nonetheless, the shader illustrates well the stencil buffer’s important role of putting this rendering technique into effect.

The resulting screenshots


  
    
      
    
  
  
    
      Picture 7: Using the SV_DepthFailBeta.shader and selecting the cylinder shadow geometry
    
  



  
    
      
    
  
  
    
      Picture 8: Using the SV_DepthFailBeta.shader in the demo project
    
  



Github Link of the demo project: 
https://github.com/liu-if-else/UnityStencilBufferUses


References:

Shadow Volume–Depth Fail - wikipedia
https://en.wikipedia.org/wiki/Shadow_volume#Depth_fail

Creating Reflections and Shadows Using Stencil - BuffersMark J. Kilgard
https://www2.cs.duke.edu/courses/spring15/cps124/classwork/14_buffers/stencil.pdf

Stencil Shadow Volume - OGL
http://ogldev.atspace.co.uk/www/tutorial40/tutorial40.html

ShaderLab: Stencil - Unity Technology
 https://docs.unity3d.com/Manual/SL-Stencil.html

Simon F’s answer to topic of ‘Uses for Stencil Buffer’ - Simon F
 https://computergraphics.stackexchange.com/questions/5046/uses-for-stencil-buffer


The Chinese version of this articel:
https://blog.csdn.net/liu_if_else/article/details/86316361

",
            "wordcount": "4433",
            "inLanguage": "en",
            "dateCreated": "2020-11-17/",
            "datePublished": "2020-11-17/",
            "dateModified": "2020-11-17/",
            "author": {
                "@type": "Person",
                "name": "liu_if_else",
                
                "image": "/assets/img/uploads/profile.png",
                
                "jobTitle": "Blogger",
                "url": "http://localhost:4000/authors/liu_if_else/",
                "sameAs": [
                    "https://github.com/liu-if-else"
                ]
            },
            "publisher": {
                "@type": "Organization",
                "name": "liu_if_else's blog",
                "url": "http://localhost:4000/",
                "logo": {
                    "@type": "ImageObject",
                    "url": "http://localhost:4000/assets/img/blog-image.png",
                    "width": "600",
                    "height": "315"
                }
            },
            "mainEntityOfPage": "True",
            "genre": "Unity3D",
            "articleSection": "Unity3D",
            "keywords": ["Shader","Unity3D"]
        }
        </script>
    </body>
</html>
